<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* Base styles for the entire page */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            overflow: hidden;
        }

        /* Toolbar for actions */
        #toolbar {
            padding: 12px 16px;
            background: #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Styling for toolbar buttons */
        button {
            padding: 10px 16px;
            background-color: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Container for the Excel table */
        #scrollContainer {
            overflow: auto;
            height: calc(100vh - 70px);
            padding: 10px;
        }

        /* Table specific styles */
        table {
            border-collapse: collapse;
            min-width: 100%;
        }

        /* Styles for table header and data cells */
        th,
        td {
            border: 1px solid #94a3b8;
            padding: 8px 12px;
            text-align: left;
            background-color: white;
            color: #1e293b;
            white-space: nowrap;
            min-width: 80px;
            box-sizing: border-box;
        }

        /* Header specific styles */
        th {
            background-color: #f1f5f9;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 5;
            cursor: pointer;
        }

        th.selected {
            background-color: #dbeafe;
        }

        /* Focus styles for editable cells */
        td[contenteditable="true"]:focus,
        th[contenteditable="true"]:focus {
            outline: 2px solid #60a5fa;
            background-color: #eff6ff;
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.5);
        }

        /* Style for the Row column */
        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 6;
            background-color: #e2e8f0;
            border-right: 2px solid #64748b;
            min-width: 60px;
        }

        th:first-child {
            z-index: 7;
            background-color: #cbd5e1;
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error message */
        .error {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            padding: 12px;
            margin: 10px;
            border-radius: 6px;
            line-height: 1.5;
        }

        /* Error container styling */
        .error-container {
            color: #dc2626;
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .error-details {
            background-color: #fff1f1;
            border: 1px solid #fecaca;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            font-size: 14px;
            line-height: 1.5;
        }

        .error-details p {
            margin: 5px 0;
        }

        /* Column selection highlight */
        .column-selected {
            background-color: #dbeafe !important;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button onclick="addNewColumn()" id="addColumnBtn">‚ûï Add Column</button>
        <button onclick="deleteSelectedColumn()" id="deleteBtn" disabled>üóëÔ∏è Delete Column</button>
        <button onclick="scrollTableLeft()">‚¨ÖÔ∏è Scroll Left</button>
        <button onclick="scrollTableRight()">‚û°Ô∏è Scroll Right</button>
        <button onclick="window.close()" style="background-color: #dc2626;">‚ùå Close</button>
    </div>

    <div id="scrollContainer">
        <div class="loading">
            <div class="spinner"></div>
            <span style="margin-left: 10px;">Loading Excel data...</span>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const taskId = urlParams.get('taskId');
        const companyId = urlParams.get('companyId');
        const userId = urlParams.get('userId');
        const userRole = urlParams.get('userRole');

        let currentData = [];
        let selectedColumn = null;
        let isUpdating = false;
        let updateTimeout = null;
        let isRendering = false;

        // ‚úÖ Backend API base URL - pointing to Spring Boot backend (from legacy/api/axios.js)
        const BASE_URL = "http://localhost:8082";

        // ‚úÖ Security configuration (from legacy/api/axios.js)
        const SECURITY_CONFIG = {
            maxRetries: 3,
            retryDelay: 1000,
            rateLimit: {
                maxRequests: 100,
                timeWindow: 60000, // 1 minute
            }
        };

        // ‚úÖ Rate limiting implementation (from legacy/api/axios.js)
        class RateLimiter {
            constructor(maxRequests, timeWindow) {
                this.maxRequests = maxRequests;
                this.timeWindow = timeWindow;
                this.requests = [];
            }

            canMakeRequest() {
                const now = Date.now();
                this.requests = this.requests.filter(time => now - time < this.timeWindow);
                
                if (this.requests.length < this.maxRequests) {
                    this.requests.push(now);
                    return true;
                }
                return false;
            }
        }

        const rateLimiter = new RateLimiter(SECURITY_CONFIG.rateLimit.maxRequests, SECURITY_CONFIG.rateLimit.timeWindow);

        // ‚úÖ Create axios instance with security headers (from legacy/api/axios.js)
        const axiosInstance = axios.create({
            baseURL: BASE_URL,
            timeout: 30000,
            headers: {
                "Content-Type": "application/json",
                "X-Requested-With": "XMLHttpRequest",
                "X-Client-Version": "1.0.0",
                "X-Platform": "web"
            }
        });

        // ‚úÖ Enhanced request interceptor with security measures (from legacy/api/axios.js)
        axiosInstance.interceptors.request.use(
            (config) => {
                // Rate limiting check
                if (!rateLimiter.canMakeRequest()) {
                    return Promise.reject(new Error('Rate limit exceeded. Please try again later.'));
                }

                // Force HTTPS in production
                if (config.url && !config.url.startsWith('https://')) {
                    config.url = config.url.replace('http://', 'https://');
                }

                // Add authentication token
                const token = localStorage.getItem('token');
                if (token) {
                    config.headers['Authorization'] = `Bearer ${token}`;
                }

                // Add request timestamp for security
                config.headers['X-Request-Timestamp'] = Date.now().toString();

                return config;
            },
            (error) => {
                return Promise.reject(error);
            }
        );

        // ‚úÖ Enhanced response interceptor with security measures (from legacy/api/axios.js)
        axiosInstance.interceptors.response.use(
            (response) => {
                // Validate response structure
                if (response.data && typeof response.data === 'object') {
                    // Remove sensitive data from response if needed
                    if (response.data.password) {
                        delete response.data.password;
                    }
                }
                return response;
            },
            (error) => {
                // Enhanced error handling with security
                if (error.response?.status === 401) {
                    const isAuthEndpoint = error.config?.url?.includes('/api/auth/');
                    const isFollowUpEndpoint = error.config?.url?.includes('/followups');
                    const isOnLogin = window.location.pathname.includes('/login') || window.location.pathname === '/';

                    // Don't logout for follow-up API errors (temporary fix for backend JPA issue)
                    if (isFollowUpEndpoint) {
                        return Promise.reject(error);
                    }

                    // Only logout for auth endpoints or if we're not on login page
                    if (isAuthEndpoint && !isOnLogin) {
                        // Clear auth data securely
                        localStorage.removeItem("token");
                        localStorage.removeItem("user");
                        sessionStorage.clear();

                        // Redirect to login
                        window.location.href = "/";
                    }
                }

                // Handle 500 errors (like your JPA parameter binding issue)
                if (error.response?.status === 500) {
                    // Don't logout for server errors
                }

                // Handle rate limiting errors
                if (error.response?.status === 429) {
                    // Rate limiting handled
                }

                // Handle network errors
                if (error.code === 'NETWORK_ERROR' || error.code === 'ERR_NETWORK') {
                    // Network error handled
                }

                return Promise.reject(error);
            }
        );

        // ‚úÖ Add retry mechanism for failed requests (from legacy/api/axios.js)
        axiosInstance.interceptors.response.use(
            (response) => response,
            async (error) => {
                const { config } = error;
                
                if (!config || !config.retry) {
                    config.retry = 0;
                }

                if (config.retry >= SECURITY_CONFIG.maxRetries) {
                    return Promise.reject(error);
                }

                config.retry += 1;
                
                // Exponential backoff
                const delay = SECURITY_CONFIG.retryDelay * Math.pow(2, config.retry - 1);
                
                await new Promise(resolve => setTimeout(resolve, delay));
                
                return axiosInstance(config);
            }
        );





        // Debounced update function
        function debouncedUpdateCell(row, col, newValue) {
            try {
                if (updateTimeout) {
                    clearTimeout(updateTimeout);
                }

                updateTimeout = setTimeout(() => {
                    updateCell(row, col, newValue);
                }, 500);
            } catch (error) {
                // Silent error handling
            }
        }

        function handleCellKeyDown(event, currentRow, currentCol) {
            if (event.key === 'Enter') {
                event.preventDefault();

                // Save current cell value first
                const currentCell = event.target;
                debouncedUpdateCell(currentRow, currentCol, currentCell.innerText);

                // Move to next row, same column
                const nextRow = currentRow + 1;

                // If next row doesn't exist, create it
                if (nextRow >= currentData.length) {
                    const maxCols = currentData.length > 0 ? Math.max(...currentData.map(row => row.length)) : 1;
                    const newRow = Array(maxCols).fill('');
                    currentData.push(newRow);
                    renderTable();
                }

                // Focus on the next row, same column
                setTimeout(() => {
                    const nextCell = document.querySelector(`td[data-row="${nextRow}"][data-col="${currentCol}"]`);
                    if (nextCell) {
                        nextCell.focus();
                        // Place cursor at the end of the cell content
                        const range = document.createRange();
                        const selection = window.getSelection();
                        range.selectNodeContents(nextCell);
                        range.collapse(false);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }, 100);
            }
        }

        // Session validation helper
        function validateSession() {
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');

            if (!user || !token) {
                alert('Session expired. Please login again.');
                window.close();
                return false;
            }

            try {
                const userData = JSON.parse(user);
                const userIdFromStorage = userData.userId || userData.id;
                const companyIdFromStorage = userData.companyId;

                if (userIdFromStorage != userId || companyIdFromStorage != companyId) {
                    alert('Session data mismatch. Please refresh and try again.');
                    return false;
                }
            } catch (e) {
                alert('Invalid session data. Please login again.');
                window.close();
                return false;
            }

            return true;
        }

        // Function to check authentication and provide login option if needed
        function checkAuthentication() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');

            if (!token || !user) {
                document.getElementById('scrollContainer').innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <div class="error-message">Authentication Required</div>
                        <div class="error-details">
                            <p>You need to be logged in to view this task.</p>
                            <p>Please log in to your account and try again.</p>
                        </div>
                        <button onclick="redirectToLogin()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 16px;">Login</button>
                    </div>
                `;
                return false;
            }
            return true;
        }

        // Function to redirect to login page
        function redirectToLogin() {
            // Store current URL to redirect back after login
            const currentUrl = window.location.href;
            localStorage.setItem('redirectAfterLogin', currentUrl);

            // Redirect to login page
            window.location.href = '/login';
        }

        // Load Excel data on page load
        window.onload = function () {
            if (!taskId || !companyId) {
                document.getElementById('scrollContainer').innerHTML =
                    '<div class="error">‚ùå Missing task ID or company ID</div>';
                return;
            }

            if (!userId || !userRole) {
                document.getElementById('scrollContainer').innerHTML =
                    '<div class="error">‚ùå Missing user information. Please try again from the dashboard.</div>';
                return;
            }

            // Check authentication before proceeding
            if (!checkAuthentication()) {
                return;
            }

            // Add event listener as fallback for add column button
            const addColumnBtn = document.getElementById('addColumnBtn');
            if (addColumnBtn) {
                addColumnBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    addNewColumn();
                });
            }

            // Load Excel data directly without role-based access validation
            loadExcelData();
        };

        async function loadExcelDataWithAxios() {
            try {
                const response = await axiosInstance.get(`/api/task-files/${taskId}/preview`, {
                    params: { companyId: companyId }
                });

                if (response.data && Array.isArray(response.data)) {
                    return response.data;
                } else {
                    throw new Error('Invalid data format received from server');
                }
            } catch (error) {
                if (error.response?.status === 403) {
                    throw new Error('Access denied. You may not have permission to view this task.');
                } else if (error.response?.status === 401) {
                    throw new Error('Authentication required. Please login again.');
                } else if (error.response?.status === 404) {
                    throw new Error('Task not found.');
                } else {
                    throw new Error(error.message || 'Failed to load Excel data');
                }
            }
        }

        async function loadExcelData() {
            try {
                const data = await loadExcelDataWithAxios();
                currentData = JSON.parse(JSON.stringify(data));
                renderTable();
            } catch (error) {
                let errorMessage = error.message;

                if (error.message.includes('Network Error')) {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.message.includes('Access denied')) {
                    errorMessage = 'Access denied. You may not have permission to view this task. Please check with your administrator.';
                } else if (error.message.includes('Authentication required')) {
                    errorMessage = 'Authentication required. Please login first and try again.';
                } else if (error.message.includes('Task not found')) {
                    errorMessage = 'Task not found. It may have been deleted.';
                }

                // Check if token might be expired or invalid
                const token = localStorage.getItem('token');
                if (token) {
                    try {
                        // Basic JWT expiration check
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        const currentTime = Date.now() / 1000;
                        if (payload.exp < currentTime) {
                            errorMessage = 'Your session has expired. Please login again.';
                        }
                    } catch (e) {
                        errorMessage = 'Invalid authentication token. Please login again.';
                    }
                }

                // Create error message
                document.getElementById('scrollContainer').innerHTML =
                    `<div class="error">‚ùå Failed to load Excel data: ${errorMessage}<br><br>
                     <p>Please ensure you are logged in and have permission to view this task.</p>
                     <p>If the problem persists, try logging out and logging back in.</p><br>

                     <button onclick="loadExcelData()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">üîÑ Retry</button>
                     <button onclick="window.close()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer;">‚ùå Close</button>
                     </div>`;
            }
        }

        function getColumnLetter(colIndex) {
            let letter = '';
            let tempIndex = colIndex;
            while (tempIndex >= 0) {
                letter = String.fromCharCode(65 + (tempIndex % 26)) + letter;
                tempIndex = Math.floor(tempIndex / 26) - 1;
            }
            return letter;
        }

        function selectColumn(colIndex) {
            // Clear previous selection
            document.querySelectorAll('th').forEach(th => th.classList.remove('selected'));
            document.querySelectorAll('td').forEach(td => td.classList.remove('column-selected'));

            if (selectedColumn === colIndex) {
                // Deselect if clicking the same column
                selectedColumn = null;
                document.getElementById('deleteBtn').disabled = true;
            } else {
                // Select new column
                selectedColumn = colIndex;
                document.getElementById('deleteBtn').disabled = false;

                // Highlight column header
                const headerCell = document.querySelector(`th[data-col="${colIndex}"]`);
                if (headerCell) {
                    headerCell.classList.add('selected');
                }

                // Highlight all cells in the column
                document.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(td => {
                    td.classList.add('column-selected');
                });
            }
        }

        function renderTable() {
            if (isRendering) {
                return;
            }

            isRendering = true;

            if (!currentData || currentData.length === 0) {
                document.getElementById('scrollContainer').innerHTML =
                    '<div class="error">‚ùå No Excel data found for this task</div>';
                isRendering = false;
                return;
            }

            let maxCols = 0;
            if (currentData.length > 0) {
                maxCols = Math.max(...currentData.map(row => row.length));
            }

            if (maxCols === 0) {
                maxCols = 5;
            }

            let html = '<table id="editableExcel">';

            // Header Row
            html += "<tr>";
            html += `<th>Row</th>`;
            for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                const colLetter = getColumnLetter(colIndex);
                html += `<th data-col="${colIndex}" onclick="selectColumn(${colIndex})" style="cursor: pointer;">
                            ${colLetter}<br>
                            <small style="font-size: 10px; color: #6b7280;">Click to select</small>
                        </th>`;
            }
            html += "</tr>";

            // Data Rows
            currentData.forEach((row, rowIndex) => {
                html += "<tr>";
                html += `<td>${rowIndex + 1}</td>`;

                for (let colIndex = 0; colIndex < maxCols; colIndex++) {
                    const safeCell = row[colIndex] ?? "";
                    html += `<td data-col="${colIndex}" data-row="${rowIndex}" contenteditable="true" 
                                onblur="debouncedUpdateCell(${rowIndex}, ${colIndex}, this.innerText)"
                                onkeydown="handleCellKeyDown(event, ${rowIndex}, ${colIndex})">
                                ${safeCell}
                            </td>`;
                }
                html += "</tr>";
            });

            html += '</table>';
            document.getElementById('scrollContainer').innerHTML = html;

            isRendering = false;
        }

        async function makeApiCall(endpoint, method = 'GET', data = null) {
            try {
                const config = {
                    method: method,
                    url: endpoint
                };

                if (data) {
                    config.data = data;
                }

                const response = await axiosInstance(config);
                return response;
            } catch (error) {
                throw error;
            }
        }

        async function updateCell(row, col, newValue) {
            if (isUpdating) {
                return;
            }

            if (!validateSession()) {
                return;
            }

            const oldValue = currentData[row]?.[col] || '';

            if (oldValue === newValue) {
                return;
            }

            isUpdating = true;

            // Update local data
            if (!currentData[row]) {
                const newRowLength = Math.max(col + 1, currentData[0] ? currentData[0].length : 0);
                currentData[row] = Array(newRowLength).fill("");
            } else {
                while (currentData[row].length <= col) {
                    currentData[row].push("");
                }
            }
            currentData[row][col] = newValue;

            try {
                const endpoint = `/api/task-files/${taskId}/update-cell?companyId=${companyId}&row=${row}&col=${col}&newValue=${encodeURIComponent(newValue)}`;

                const response = await makeApiCall(endpoint, 'PATCH');

            } catch (error) {
                // Revert on error
                currentData[row][col] = oldValue;

                if (error.response?.status === 400) {
                    alert('Invalid request format. Please try again.');
                } else if (error.response?.status === 401) {
                    alert('Session expired. Please refresh the page and login again.');
                } else if (error.response?.status === 403) {
                    alert('Access denied. You may not have permission to edit this task.');
                } else if (error.response?.status === 404) {
                    alert('Task not found. It may have been deleted.');
                } else if (error.code === 'NETWORK_ERROR' || error.code === 'ERR_NETWORK') {
                    alert('Cannot connect to server. Please check your connection.');
                } else {
                    alert(`Failed to update cell: ${error.message || 'Unknown error'}`);
                }
            } finally {
                isUpdating = false;
            }
        }

        async function addNewColumn() {
            try {
                // Get the current number of columns
                const currentColCount = currentData.length > 0 ? Math.max(...currentData.map(row => row.length)) : 0;

                // Add empty column to all rows locally first
                currentData.forEach(row => {
                    row.push('');
                });

                // If no data exists, create first row with empty column
                if (currentData.length === 0) {
                    currentData.push(['']);
                }

                // Re-render the table immediately
                renderTable();

                // Try to make API call to persist the column (but don't block if it fails)
                try {
                    const endpoint = `/api/task-files/${taskId}/add-column?companyId=${companyId}`;
                    await makeApiCall(endpoint, 'POST');
                } catch (apiError) {
                    // Don't show alert to user since column was added locally
                }

            } catch (e) {
                alert(`Error adding column: ${e.message}`);
            }
        }

        async function deleteSelectedColumn() {
            if (selectedColumn === null) {
                alert('Please select a column to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete column ${getColumnLetter(selectedColumn)}?`)) {
                return;
            }

            try {
                const endpoint = `/api/task-files/${taskId}/delete-column?companyId=${companyId}&colIndex=${selectedColumn}`;
                await makeApiCall(endpoint, 'DELETE');

                // Remove column from local data
                currentData.forEach(row => {
                    if (selectedColumn < row.length) {
                        row.splice(selectedColumn, 1);
                    }
                });

                selectedColumn = null;
                document.getElementById('deleteBtn').disabled = true;
                renderTable();

            } catch (error) {
                if (error.response?.status === 401) {
                    alert('Session expired. Please refresh the page and login again.');
                } else if (error.response?.status === 400) {
                    alert('Invalid column index or column does not exist.');
                } else if (error.code === 'NETWORK_ERROR' || error.code === 'ERR_NETWORK') {
                    alert('Cannot connect to server. Please check your connection.');
                } else {
                    alert(`Failed to delete column: ${error.message || 'Unknown error'}`);
                }
            }
        }

        function scrollTableLeft() {
            document.getElementById('scrollContainer').scrollBy({
                left: -200,
                behavior: 'smooth'
            });
        }

        function scrollTableRight() {
            document.getElementById('scrollContainer').scrollBy({
                left: 200,
                behavior: 'smooth'
            });
        }
    </script>
</body>

</html>